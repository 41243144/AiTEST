{% extends 'analyzer/base.html' %}

{% block title %}拍照分析 - 農產品智慧分析平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- 標題區塊 -->
        <div class="text-center mb-4">
            <h2 class="text-success">
                <i class="fas fa-camera-retro"></i> 農產品智慧分析
            </h2>
            <p class="text-muted">
                <i class="fas fa-leaf"></i> 上傳您的農產品圖片，AI 將為您提供專業的品質分析與市場建議
            </p>
        </div>

        <!-- 使用說明 -->
        <div class="row mb-4">
            <div class="col-md-4 text-center mb-3">
                <div class="feature-icon mx-auto mb-2" style="width: 60px; height: 60px;">
                    <i class="fas fa-camera fa-lg text-white"></i>
                </div>
                <h6 class="text-success">1. 拍攝或選擇</h6>
                <small class="text-muted">清晰拍攝農產品照片</small>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="feature-icon mx-auto mb-2" style="width: 60px; height: 60px;">
                    <i class="fas fa-upload fa-lg text-white"></i>
                </div>
                <h6 class="text-success">2. 上傳分析</h6>
                <small class="text-muted">點擊上傳開始AI分析</small>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="feature-icon mx-auto mb-2" style="width: 60px; height: 60px;">
                    <i class="fas fa-chart-bar fa-lg text-white"></i>
                </div>
                <h6 class="text-success">3. 獲得結果</h6>
                <small class="text-muted">查看專業分析報告</small>
            </div>
        </div>

        <div class="card">
            <div class="card-header text-center" style="background: linear-gradient(135deg, #5e8a3a 0%, #7ba05b 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-seedling"></i> 選擇農產品圖片
                </h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- 拖放上傳區域 -->
                    <div class="upload-area mb-4" id="uploadArea">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt fa-4x text-success mb-3"></i>
                            <h5 class="text-success">拖放圖片到此處或點擊選擇</h5>
                            <p class="text-muted mb-3">
                                支援 JPG、PNG、GIF 格式 | 建議檔案大小小於 10MB
                            </p>
                            
                            <!-- 檔案輸入 -->
                            <div class="mb-3">
                                {{ form.image }}
                            </div>
                            
                            <!-- 預覽區域 -->
                            <div id="imagePreview" class="mb-3" style="display: none;">
                                <img id="previewImg" class="image-preview" alt="預覽圖片">
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPreview()">
                                        <i class="fas fa-times"></i> 重新選擇
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 提交按鈕 -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" disabled>
                            <i class="fas fa-microscope"></i> 開始 AI 分析
                        </button>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> 分析過程約需 10-30 秒
                            </small>
                        </div>
                    </div>
                </form>

                <!-- 載入動畫 -->
                <div id="loadingDiv" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">分析中...</span>
                    </div>
                    <div class="mt-3">
                        <h5 class="text-success">AI 正在分析您的農產品...</h5>
                        <p class="text-muted">
                            <i class="fas fa-robot"></i> 請稍候，正在識別品種、評估品質並計算建議價格
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 拍攝提示 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-body">
                        <h6 class="card-title text-success">
                            <i class="fas fa-check-circle"></i> 最佳拍攝建議
                        </h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-sun text-warning"></i> 充足自然光線</li>
                            <li><i class="fas fa-crop text-info"></i> 農產品居中拍攝</li>
                            <li><i class="fas fa-eye text-primary"></i> 清晰對焦無模糊</li>
                            <li><i class="fas fa-palette text-success"></i> 背景簡潔乾淨</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-exclamation-triangle"></i> 注意事項
                        </h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-times text-danger"></i> 避免過暗或反光</li>
                            <li><i class="fas fa-times text-danger"></i> 不要過度濾鏡處理</li>
                            <li><i class="fas fa-times text-danger"></i> 避免遮擋主要部位</li>
                            <li><i class="fas fa-shield-alt text-info"></i> 圖片將安全處理</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 範例圖片 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-images"></i> 適用農產品類型
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <i class="fas fa-apple-alt fa-3x text-danger mb-2"></i>
                            <small class="d-block fw-bold">水果類</small>
                            <small class="text-muted">蘋果、橘子、香蕉...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <i class="fas fa-carrot fa-3x text-warning mb-2"></i>
                            <small class="d-block fw-bold">根莖類</small>
                            <small class="text-muted">紅蘿蔔、白蘿蔔、馬鈴薯...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <i class="fas fa-seedling fa-3x text-success mb-2"></i>
                            <small class="d-block fw-bold">葉菜類</small>
                            <small class="text-muted">高麗菜、菠菜、青江菜...</small>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3">
                        <div class="border rounded p-3 h-100">
                            <i class="fas fa-pepper-hot fa-3x text-danger mb-2"></i>
                            <small class="d-block fw-bold">香辛料</small>
                            <small class="text-muted">辣椒、薑、蒜...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('id_image');
    const uploadArea = document.getElementById('uploadArea');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const submitBtn = document.getElementById('submitBtn');
    const loadingDiv = document.getElementById('loadingDiv');

    // 檔案選擇處理
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    });

    // 拖放功能
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFile(files[0]);
        }
    });

    // 處理檔案
    function handleFile(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                submitBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            alert('請選擇有效的農產品圖片檔案');
        }
    }

    // 清除預覽
    window.clearPreview = function() {
        imagePreview.style.display = 'none';
        fileInput.value = '';
        submitBtn.disabled = true;
    };

    // 表單提交
    form.addEventListener('submit', function(e) {
        if (!fileInput.files[0]) {
            e.preventDefault();
            alert('請先選擇要分析的農產品圖片');
            return;
        }

        submitBtn.style.display = 'none';
        loadingDiv.style.display = 'block';
    });
});
</script>
{% endblock %}